<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smooth Transition Text Display</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f7f7f7;
        }
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333; /* 墨色 */
            z-index: -1; /* 确保这个伪元素在contentDiv之下 */
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, rgba(200, 200, 200, 0.05), rgba(200, 200, 200, 0));
            border-radius: 10px;
            padding: 20px;
            width: 80vw;
            height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-family: 'Arial', sans-serif;
            font-size: 20px;
            overflow: hidden;
        }
        #textContent {
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            text-align: center;
        }
        #refreshButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #refreshButton:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="contentDiv" class="glass-effect">
        <div id="textContent"></div>
        <button id="refreshButton">下一条</button>
    </div>

    <script>
        let scrollInterval;  // 用来存储滚动定时器
        let isTextUpdating = false;  // 防止重复触发更新
        let cachedData = [];  // 缓存的数据
        let currentIndex = 0;  // 当前显示的记录索引
        const cacheTimeout = 60 * 1000; // 缓存有效期为1分钟

        // 清除滚动逻辑
        function stopScrollingText() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        // 启动逐字滚动逻辑
        function enableScrollingText(text) {
            const textContent = document.getElementById('textContent');
            const contentDiv = document.getElementById('contentDiv');
            let fontSize = 35;
            if (text.length > 10) {
                fontSize = Math.max(35 - (text.length - 10) * 0.5, 12);
            }
            const visibleLength = Math.floor(contentDiv.clientWidth / (fontSize * 0.6));
            let start = 0;
            const updateText = () => {
                const displayText = text.slice(start, start + visibleLength);
                textContent.innerText = displayText;
                start = (start + 1) % text.length;
            };
            scrollInterval = setInterval(updateText, 300); // 每 300 毫秒更新一次
        }

        // 从缓存或服务器获取数据
        function fetchDataFromCacheOrServer() {
            if (cachedData.length > 0 && (Date.now() - cachedData[0].timestamp < cacheTimeout)) {
                showNextRecord();
            } else {
                fetch('/refresh_content')
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.records && data.records.length > 0) {
                            cachedData = data.records.map(record => ({
                                text: record,
                                timestamp: Date.now()
                            }));
                            currentIndex = 0;
                            showNextRecord();
                        } else {
                            console.error('No records returned from server');
                            enableScrollingText('暂无数据');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        enableScrollingText('请求失败');
                    });
            }
        }

        // 显示下一条记录
        function showNextRecord() {
            if (cachedData.length > 0) {
                const record = cachedData[currentIndex];
                enableScrollingText(record.text);
                currentIndex = (currentIndex + 1) % cachedData.length;
            } else {
                enableScrollingText('暂无数据');
            }
        }

        // 点击刷新按钮时，发送 AJAX 请求获取新内容
        document.addEventListener("DOMContentLoaded", function() {
            const refreshButton = document.getElementById('refreshButton');
            const textContent = document.getElementById('textContent');

            refreshButton.addEventListener('click', () => {
                if (isTextUpdating) return; // 防止重复点击

                isTextUpdating = true;  // 标记更新状态

                // 停止当前的滚动
                stopScrollingText();

                // 清空当前文本内容并显示加载状态（可选）
                // textContent.innerText = '加载中...';

                // 发送请求获取新文本
                setTimeout(() => {
                    fetchDataFromCacheOrServer();
                    isTextUpdating = false;  // 结束更新状态
                }, 500); // 延迟加载以避免跳跃效果
            });

            // 初始化时尝试从缓存或服务器获取数据
            fetchDataFromCacheOrServer();
        });
    </script>
</body>
</html>