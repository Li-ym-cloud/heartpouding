<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smooth Transition Text Display</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f7f7f7;
        }
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333; /* 墨色 */
            z-index: -1; /* 确保这个伪元素在contentDiv之下 */
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, rgba(200, 200, 200, 0.05), rgba(200, 200, 200, 0));
            border-radius: 10px;
            padding: 20px;
            width: 80vw;
            height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-family: 'Arial', sans-serif;
            font-size: 20px;
            overflow: hidden;
        }
        #textContent {
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            text-align: center;
        }
        #refreshButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #refreshButton:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="contentDiv" class="glass-effect">
        <div id="textContent"></div>
        <button id="refreshButton">下一条</button>
    </div>

    <script>
        let scrollInterval;  // 用来存储滚动定时器
        let isTextUpdating = false;  // 防止重复触发更新
        let cachedData = [];  // 缓存的数据
        let currentIndex = 0;  // 当前显示的记录索引
        const cacheTimeout = 60 * 1000; // 缓存有效期为1分钟
        let up_next = 0;

        // 清除滚动逻辑
        function stopScrollingText() {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        // 启动逐字滚动逻辑
        function enableScrollingText(text, delay = 500) {
            stopScrollingText();  // 先停止任何现有的滚动逻辑

            const textContent = document.getElementById('textContent');
            const contentDiv = document.getElementById('contentDiv');
            let fontSize = 35;
            if (text.length > 10) {
                fontSize = Math.max(35 - (text.length - 10) * 0.5, 12);
            }
            const visibleLength = Math.floor(contentDiv.clientWidth / (fontSize * 0.6));
            let start = 0;
            const updateText = () => {
                textContent.innerHTML = '';
                const displayText = text.slice(start, start + visibleLength).padEnd(visibleLength, ' ');
                textContent.innerText = displayText; // 使用 innerHTML 替换 innerText
                start = (start + 1) % text.length;
            };

            // 延迟一段时间再开始滚动
            setTimeout(() => {
                scrollInterval = setInterval(updateText, 200);
            }, delay);
        }

        // 从缓存或服务器获取数据
        function fetchDataFromCacheOrServer() {
            if (cachedData.length > 0 && (Date.now() - cachedData[0].timestamp < cacheTimeout)) {
                // 缓存有效，直接显示下一条记录
                showNextRecord();
            } else {
                // 缓存无效或为空，从服务器请求数据
                stopScrollingText();  // 停止当前的滚动逻辑
                document.getElementById('textContent').innerHTML = '';  // 清空显示内容

                fetch('/refresh_content')
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.records && data.records.length > 0) {
                            // 更新缓存数据
                            cachedData = data.records.map(record => ({
                                text: record,
                                timestamp: Date.now()
                            }));
                            currentIndex = 0;
                            // 显示第一条记录
                            showNextRecord();
                        } else {
                            // 没有新数据，显示提示信息
                            enableScrollingText('暂无数据');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        enableScrollingText('请求失败');
                    });
            }
        }

        // 显示下一条记录
        function showNextRecord() {
            if (cachedData.length > 0) {
                if (currentIndex >= cachedData.length) {
                    cachedData = [];
                    fetchDataFromCacheOrServer(); // 刷新数据
                }else {
                    const record = cachedData[currentIndex];
                    enableScrollingText(record.text);
                    currentIndex = currentIndex + 1;
                }
            } else {
                enableScrollingText('暂无数据');
            }
        }

        // 点击刷新按钮时，发送 AJAX 请求获取新内容
        document.addEventListener("DOMContentLoaded", function() {
            const refreshButton = document.getElementById('refreshButton');

            refreshButton.addEventListener('click', () => {
                if (isTextUpdating) return; // 防止重复点击

                isTextUpdating = true;  // 标记更新状态

                // 停止当前的滚动
                stopScrollingText();

                // 如果缓存中有数据，则直接显示下一条，否则清除缓存并请求新数据
                if (cachedData.length > 0) {
                    showNextRecord();
                    isTextUpdating = false;  // 结束更新状态
                } else {
                    // 清除缓存
                    cachedData = [];
                    // 发送请求获取新文本
                    setTimeout(() => {
                        fetchDataFromCacheOrServer();
                        isTextUpdating = false;  // 结束更新状态
                    }, 500); // 延迟加载以避免跳跃效果
                }
            });

            // 初始化时尝试从缓存或服务器获取数据
            fetchDataFromCacheOrServer();
        });
    </script>
</body>
</html>